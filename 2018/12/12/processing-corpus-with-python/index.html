<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="tips,Python,linguistics,">





  <link rel="alternate" href="/atom.xml" title="Hael's Blog" type="application/atom+xml">






<meta name="description" content="Recently I’ve been doing a corpus-based research. There are several corpus tools available. Some are free, like AntConc, #LancsBox; and some are paid, like WordSmith and PowerGREP. The paid softwares">
<meta name="keywords" content="tips,Python,linguistics">
<meta property="og:type" content="article">
<meta property="og:title" content="Processing Corpus with Python">
<meta property="og:url" content="http://haelchan.me/2018/12/12/processing-corpus-with-python/index.html">
<meta property="og:site_name" content="Hael&#39;s Blog">
<meta property="og:description" content="Recently I’ve been doing a corpus-based research. There are several corpus tools available. Some are free, like AntConc, #LancsBox; and some are paid, like WordSmith and PowerGREP. The paid softwares">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://haelchan.me/images/corpus/clickNew.jpg">
<meta property="og:image" content="http://haelchan.me/images/corpus/lcmc.jpg">
<meta property="og:updated_time" content="2019-01-26T15:55:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Processing Corpus with Python">
<meta name="twitter:description" content="Recently I’ve been doing a corpus-based research. There are several corpus tools available. Some are free, like AntConc, #LancsBox; and some are paid, like WordSmith and PowerGREP. The paid softwares">
<meta name="twitter:image" content="http://haelchan.me/images/corpus/clickNew.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://haelchan.me/2018/12/12/processing-corpus-with-python/">





  <title>Processing Corpus with Python | Hael's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hael's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://haelchan.me/2018/12/12/processing-corpus-with-python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hael Chan">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hael's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Processing Corpus with Python</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-12T02:58:56-08:00">
                2018-12-12
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2019-01-26T07:55:24-08:00">
                2019-01-26
              </time>
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/12/processing-corpus-with-python/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/12/processing-corpus-with-python/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/12/12/processing-corpus-with-python/" class="leancloud_visitors" data-flag-title="Processing Corpus with Python">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Recently I’ve been doing a corpus-based research. There are several corpus tools available. Some are free, like <a href="http://www.laurenceanthony.net/software/antconc/" target="_blank" rel="external">AntConc</a>, <a href="http://corpora.lancs.ac.uk/lancsbox/" target="_blank" rel="external">#LancsBox</a>; and some are paid, like <a href="https://www.lexically.net/wordsmith/" target="_blank" rel="external">WordSmith</a> and <a href="https://www.powergrep.com" target="_blank" rel="external">PowerGREP</a>. The paid softwares are too expensive, and the free softwares just provide some general functions and cannot meet my requirements. Therefore, I decided to implement the processing procedure using Python on my own. <a href="http://www.nltk.org" target="_blank" rel="external">NLTK</a> offers methods to load corpus, but it doens’t support tagged corpus. So I just start it from pure Python. In this post, I’d keep my experience with code. I’ll try to make it as detailed as possible so that some of my best friends majoring in linguistics can benefit from this post and maybe process corpus with Python at their will :D  (Or perhaps you are a bit frustrated with code. Don’t worry. Later I will upload some helper Python programs so that you can execute them directly, without dealing with code.)</p>
<h2 id="Before-Getting-Started"><a href="#Before-Getting-Started" class="headerlink" title="Before Getting Started"></a>Before Getting Started</h2><h3 id="Jupyter-Notebook"><a href="#Jupyter-Notebook" class="headerlink" title="Jupyter Notebook"></a>Jupyter Notebook</h3><h4 id="Download-Anaconda"><a href="#Download-Anaconda" class="headerlink" title="Download Anaconda"></a>Download Anaconda</h4><p>It is okay whether you have known Python before or not. As long as you have learned some programming language, e.g., Java or C,  that’s enough. Python is user-friendly and easy to use. You can refer to <a href="https://docs.python.org/3/tutorial/index.html" target="_blank" rel="external">Python’s official tutorial</a> any time for better understanding, or you can just leave it out and follow my post step by step. Anyway, I’d suggest that you download <a href="https://www.anaconda.com/download/" target="_blank" rel="external">Anaconda</a>. It is straight-forward and helps to manage trouble-some settings. You can write code freely once you installed it. And I’d highly recommend writing in Jupyter Notebook, which is installed together with Anaconda.  </p>
<h4 id="Launch-Jupyter-Notebook"><a href="#Launch-Jupyter-Notebook" class="headerlink" title="Launch Jupyter Notebook"></a>Launch Jupyter Notebook</h4><ul>
<li><p>For Windows users, click Open Menu (or press <code>Windows key</code> on the keyboard) - Anaconda3 - Jupyter Notebook. </p>
</li>
<li><p>For macOS users, open Launchpad (or press <code>F4</code> on the keyboard) - Anaconda Navigator - notebook.</p>
</li>
</ul>
<p>After that, a command window (black in Windows, white in macOS) will pop up. You can ignore it (but don’t close it!). Then your default browser will open automatically. Click <em>New</em> on the top right corner and select <em>Python 3</em>, you can start writing Python code now!  </p>
<p><img src="/images/corpus/clickNew.jpg" alt></p>
<h4 id="Basic-of-Jupyter-Notebook"><a href="#Basic-of-Jupyter-Notebook" class="headerlink" title="Basic of Jupyter Notebook"></a>Basic of Jupyter Notebook</h4><p>The notebook consists of a sequence of cells. There are three types of cells: <strong>code cells</strong>, <strong>markdown cells</strong>, and <strong>raw cells</strong>. By default, the cell is code cell, and you can write Python code directly. You don’t need to worry about markdown or raw cells.  </p>
<p>The cell has two modes: <strong>command mode</strong> and <strong>edit mode</strong>. Generally, the cell is in edit mode and you can type freely. If it’s in command mode, you can navigate around the notebook using keyboard shortcuts.  </p>
<h4 id="Keyboard-Shortcuts"><a href="#Keyboard-Shortcuts" class="headerlink" title="Keyboard Shortcuts"></a>Keyboard Shortcuts</h4><p><code>Shift + Enter</code>: run cell  </p>
<p><code>Esc</code>: turn cell into command mode  </p>
<p><code>Enter</code>: turn cell into edit mode  </p>
<p><code>D, D</code>: delete the cell  </p>
<p><code>A</code>: insert cell above  </p>
<p><code>B</code>: insert cell below  </p>
<p>These are shortcuts that I use most frequently. For the full list of available shortcuts, click Help - Keyboard Shortcuts in the notebook menus.</p>
<p>Well, this is a simple introduction to Jupyter Notebook. You can download my <a href="https://github.com/HaelChan/Processing-Corpus-with-Python/archive/master.zip" target="_blank" rel="external">code</a> and open processing.ipynb using Jupyter Notebook, or you can continue reading this post and type the code on your own. The following content is almost the same.</p>
<h4 id="Shutdown"><a href="#Shutdown" class="headerlink" title="Shutdown"></a>Shutdown</h4><p>Oops, I almost forget to tell you how you shut down Jupyter Notebook when you’ve finished your work. Return to the command window, press <code>Ctrl+C</code> twice quickly. Then Jupyter Notebook will shut down and everything will be okay.</p>
<h3 id="Get-an-Overview-of-Your-Corpus"><a href="#Get-an-Overview-of-Your-Corpus" class="headerlink" title="Get an Overview of Your Corpus"></a>Get an Overview of Your Corpus</h3><p>You have to glance through your corpus before processing. Generally the format of corpus is <code>.txt</code> or <code>.xml</code>. You can use the default text editor in your operating system to open the file, or you can use some advanced text editor like <a href="https://www.sublimetext.com" target="_blank" rel="external">Sublime Text</a> for better view.</p>
<p><img src="/images/corpus/lcmc.jpg" alt></p>
<p>The above  image shows the heading of LCMC_A.xml. (<em>The Lancaster Corpus of Mandarin Chinese (LCMC)</em> addresses an increasing need within the research community for a publicly available balanced corpus of Mandarin Chinese. Click <a href="http://www.lancaster.ac.uk/fass/projects/corpus/LCMC/" target="_blank" rel="external">here</a> for more information about this corpus.) We don’t need to care the heading, which indicate the information about creator, date, etc. By focusing the main body, we can know each word is tagged with  <code>&lt;w POS=&quot;&quot;&gt;</code> and followed by <code>&lt;/w&gt;</code>, like <code>&lt;w POS=&quot;a&quot;&gt;大&lt;/w&gt;</code>. Different corpora may have different taggings, here (and in the following sections) I just take LCMC as an example.</p>
<h2 id="Process-a-Single-File"><a href="#Process-a-Single-File" class="headerlink" title="Process a Single File"></a>Process a Single File</h2><p>All right. Let’s get started with a single file. </p>
<h3 id="Read-the-File"><a href="#Read-the-File" class="headerlink" title="Read the File"></a>Read the File</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">filename = <span class="string">'LCMC_A.xml'</span></div><div class="line"><span class="keyword">with</span> open(filename, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</div><div class="line">    read_data = f.read()</div></pre></td></tr></table></figure>
<p>The first line declares a variable called <em>filename</em>. The second line tells the system to open the file. Note that <code>encoding=&#39;utf-8&#39;</code> indicates the encoding of the file, and currently <em>utf-8</em> is the most frequently used encoding. If you don’t know the file’s encoding, take utf-8 by default. Later I’ll write how to dealing with other encodings. The third line just read the entire content and pass it to a variable <em>read_data</em>.  </p>
<p>You can type <code>read_data</code> in a new cell and run the cell to see whether it’s successful.</p>
<h3 id="Extract-Useful-Parts"><a href="#Extract-Useful-Parts" class="headerlink" title="Extract Useful Parts"></a>Extract Useful Parts</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> re</div><div class="line">tag = re.findall(<span class="string">r'&lt;w POS="(\w&#123;0,4&#125;)"&gt;.&#123;0,7&#125;&lt;/w&gt;'</span>, read_data)</div><div class="line">token = re.findall(<span class="string">r'&lt;w POS="\w&#123;0,4&#125;"&gt;(.&#123;0,7&#125;)&lt;/w&gt;'</span>, read_data)</div></pre></td></tr></table></figure>
<p>The most useful information is the tags and the tokens. With the above code we can extract these parts parallelly (in two seperate lists). Here I use the regular expression (re) and maybe it is a bit abstruce. Well, currently you just need to know what it does: recall the word form: <code>&lt;w POS=&quot;a&quot;&gt;大&lt;/w&gt;</code>, the second line extract the content between the quotes(<code>a</code>, which is a tag); the third line extract the content between the right angle bracket and the left angle bracket(<code>大</code>, which is a token).  </p>
<p>Note that with the above codes I just extract words, not including punctuations. If you need to treat punctuations as tokens, use the following code instead:  </p>
<p><code>tag = re.findall(r&#39;&lt;[wc] POS=&quot;(\w{0,4})&quot;&gt;.{0,7}&lt;/[wc]&gt;&#39;, read_data)</code>,  </p>
<p><code>token = re.findall(r&#39;&lt;[wc] POS=&quot;\w{0,4}&quot;&gt;(.{0,7})&lt;/[wc]&gt;&#39;, read_data)</code>.  </p>
<p>You can refer to my <a href="http://haelchan.me/2018/05/23/regular-expression/">post</a> for more information about regular expression.</p>
<h3 id="Count-Frequency"><a href="#Count-Frequency" class="headerlink" title="Count Frequency"></a>Count Frequency</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> collections</div><div class="line">counter = collections.Counter(token)</div><div class="line">counter.most_common()</div></pre></td></tr></table></figure>
<p>Since we have extract the useful part, we can count the frequencies. The first line import a library <code>collections</code> for counting. The second line counts the token list and the third line outputs the frequency in reverse order. </p>
<h3 id="Index-Target-Word"><a href="#Index-Target-Word" class="headerlink" title="Index Target Word"></a>Index Target Word</h3><p>Well, the freguency just gives us an overview. Then let’s focus on our target words. We need to know the word’s occurrence in the corpus. For example, the following line helps to find all indices of the word ‘是’.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">indices = [i <span class="keyword">for</span> i, x <span class="keyword">in</span> enumerate(token) <span class="keyword">if</span> x == <span class="string">'是'</span>]</div></pre></td></tr></table></figure>
<p>With the indices we get, now we can perform a variety of tasks. We can see the concordance of the word, n-gram, etc.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">pre_token = [token[i<span class="number">-1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> indices]</div><div class="line">next_token = [token[i+<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> indices]</div><div class="line"></div><div class="line">pre_tag = [tag[i<span class="number">-1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> indices]</div><div class="line">next_tag = [tag[i+<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> indices]</div></pre></td></tr></table></figure>
<p>The first two lines stores the tokens before ‘是’ and the tokens next ‘是’ separately, and the last two lines stores the tags before ‘是’ and the tags next ‘是’.</p>
<h3 id="KWIC"><a href="#KWIC" class="headerlink" title="KWIC"></a>KWIC</h3><p>Key Word In Context(KWIC) is a typical application in corpus linguistics. We can print KWIC easily with the indices we get:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> indices:</div><div class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> range(<span class="number">-5</span>, <span class="number">6</span>):</div><div class="line">        print(token[i+w], end=<span class="string">' '</span>)</div><div class="line">    print()</div></pre></td></tr></table></figure>
<p>(Well, here the code is simplified, without considering OutOfIndex exception.)</p>
<h3 id="Export-to-Excel"><a href="#Export-to-Excel" class="headerlink" title="Export to Excel"></a>Export to Excel</h3><p>Maybe you are more familiar to Excel. You can export the statistics you get by Python as well.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line">pd.DataFrame(counter.most_common()).to_excel(<span class="string">'most_common.xlsx'</span>, header=<span class="keyword">False</span>, index=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<p>With these two lines of code executed, you can see that a new excel file is generated in your current directory. Then you can view the data in your Excel.</p>
<h2 id="Process-All-Files"><a href="#Process-All-Files" class="headerlink" title="Process All Files"></a>Process All Files</h2><h3 id="Load-Files"><a href="#Load-Files" class="headerlink" title="Load Files"></a>Load Files</h3><p>Generally, a corpus may contain several files. Now that we have done with a single file, it’s easy to  process all the files as well. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line">files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir() <span class="keyword">if</span> f.endswith(<span class="string">'.xml'</span>)]</div></pre></td></tr></table></figure>
<p>The above code will list the current directory’s files, whose filename extension is <code>.xml</code>. With these files, we can read all files within a <code>for</code> loop.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">tags = []</div><div class="line">tokens = []</div><div class="line"></div><div class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> files:</div><div class="line">    <span class="keyword">with</span> open(filename, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</div><div class="line">    	read_data = f.read()</div><div class="line">    tag = re.findall(<span class="string">r'&lt;w POS="(\w&#123;0,4&#125;)"&gt;.&#123;0,7&#125;&lt;/w&gt;'</span>, read_data)</div><div class="line">	token = re.findall(<span class="string">r'&lt;w POS="\w&#123;0,4&#125;"&gt;(.&#123;0,7&#125;)&lt;/w&gt;'</span>, read_data)</div><div class="line">    tags.extend(tag)</div><div class="line">    tokens.extend(token)</div></pre></td></tr></table></figure>
<p>Here the <code>tag</code> and <code>token</code> is just the same as what was mentioned in the previous section. The difference lies in that I declared two new variables, <code>tags</code> and <code>tokens</code> to store the entire tags and tokens in the corpus (while the <code>tag</code> and <code>token</code> only store those in only one file). The last two lines just merge the <code>tag</code> to <code>tags</code>.  </p>
<h3 id="Define-Functions"><a href="#Define-Functions" class="headerlink" title="Define Functions"></a>Define Functions</h3><p>Some lines of code have its particular purpose and may be executed several times. It’s a good idea to wrap those code in a <em>function</em> for reutilization. It helps to simplify our programs and make it easier to use and comprehend.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">previous_tokens</span><span class="params">(target)</span>:</span></div><div class="line">    indices = [i <span class="keyword">for</span> i, x <span class="keyword">in</span> enumerate(token) <span class="keyword">if</span> x == target]</div><div class="line">    pre_token = [token[i<span class="number">-1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> indices]</div><div class="line">    <span class="keyword">return</span> pre_token</div></pre></td></tr></table></figure>
<p>For example, we define a function called <code>previous_tokens</code>. With the above board written, we can call it easily. <code>previous_tokens(&#39;的&#39;)</code> will give us the previous tags of ‘的’.</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    Hael Chan
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="http://haelchan.me/2018/12/12/processing-corpus-with-python/" title="Processing Corpus with Python">http://haelchan.me/2018/12/12/processing-corpus-with-python/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/tips/" rel="tag"># tips</a>
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/linguistics/" rel="tag"># linguistics</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/08/pytorch-note/" rel="next" title="Points on PyTorch">
                <i class="fa fa-chevron-left"></i> Points on PyTorch
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/10/LM-in-detail/" rel="prev" title="From statistical to neural - language modeling in detail">
                From statistical to neural - language modeling in detail <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Hael Chan">
            
              <p class="site-author-name" itemprop="name">Hael Chan</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/haelchan" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:f.procumbens@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/Procumbens" target="_blank" title="Twitter">
                    
                      <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="www.linkedin.com/in/haoliang-chen" target="_blank" title="LinkedIn">
                    
                      <i class="fa fa-fw fa-linkedin"></i>LinkedIn</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://ruder.io" title="Sebastian Ruder" target="_blank">Sebastian Ruder</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://smerity.com" title="Semerity" target="_blank">Semerity</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://einstein.ai/research/blog" title="Salesforce Research" target="_blank">Salesforce Research</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.reddit.com/r/LanguageTechnology/" title="Reddit" target="_blank">Reddit</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://learnerwn.github.io" title="WN_Blog" target="_blank">WN_Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://hey-yahei.cn" title="YaHei" target="_blank">YaHei</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://godweiyang.com" title="WeiYang Blog" target="_blank">WeiYang Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.linzehui.me" title="Weekly Review" target="_blank">Weekly Review</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jalammar.github.io" title="Jay Alammar" target="_blank">Jay Alammar</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Before-Getting-Started"><span class="nav-number">1.</span> <span class="nav-text">Before Getting Started</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jupyter-Notebook"><span class="nav-number">1.1.</span> <span class="nav-text">Jupyter Notebook</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Download-Anaconda"><span class="nav-number">1.1.1.</span> <span class="nav-text">Download Anaconda</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Launch-Jupyter-Notebook"><span class="nav-number">1.1.2.</span> <span class="nav-text">Launch Jupyter Notebook</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Basic-of-Jupyter-Notebook"><span class="nav-number">1.1.3.</span> <span class="nav-text">Basic of Jupyter Notebook</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Keyboard-Shortcuts"><span class="nav-number">1.1.4.</span> <span class="nav-text">Keyboard Shortcuts</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Shutdown"><span class="nav-number">1.1.5.</span> <span class="nav-text">Shutdown</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Get-an-Overview-of-Your-Corpus"><span class="nav-number">1.2.</span> <span class="nav-text">Get an Overview of Your Corpus</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Process-a-Single-File"><span class="nav-number">2.</span> <span class="nav-text">Process a Single File</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Read-the-File"><span class="nav-number">2.1.</span> <span class="nav-text">Read the File</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Extract-Useful-Parts"><span class="nav-number">2.2.</span> <span class="nav-text">Extract Useful Parts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Count-Frequency"><span class="nav-number">2.3.</span> <span class="nav-text">Count Frequency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Index-Target-Word"><span class="nav-number">2.4.</span> <span class="nav-text">Index Target Word</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KWIC"><span class="nav-number">2.5.</span> <span class="nav-text">KWIC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Export-to-Excel"><span class="nav-number">2.6.</span> <span class="nav-text">Export to Excel</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Process-All-Files"><span class="nav-number">3.</span> <span class="nav-text">Process All Files</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Load-Files"><span class="nav-number">3.1.</span> <span class="nav-text">Load Files</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Define-Functions"><span class="nav-number">3.2.</span> <span class="nav-text">Define Functions</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hael Chan</span>

  
</div>









<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<span id="busuanzi_container_site_uv">
  Welcome~ Thanks for visiting my blog. You are the №.<span id="busuanzi_value_site_uv"></span> visitor.
</span>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://hael.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://haelchan.me/2018/12/12/processing-corpus-with-python/';
          this.page.identifier = '2018/12/12/processing-corpus-with-python/';
          this.page.title = 'Processing Corpus with Python';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://hael.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'manual') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("3HhWLTewaKTSPj5DC3qp5b2m-gzGzoHsz", "zjxN2hpHQEmyMaz0XBicI3bn");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  


  

  

</body>
</html>
